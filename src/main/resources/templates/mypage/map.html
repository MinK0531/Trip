<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_head}">

<div layout:fragment="fragment">
    <div id="chartdiv">
        <div class="profile-card-container">
            <div class="boarding-pass">
                <div class="top-stripe" >
                    <img src="/img/top-stripe.png"
                         alt="ÌîÑÎ°úÌïÑ Î®∏Î¶¨">
                </div>

                <div class="pass-content">
                    <div class="top-section">
                        <div class="profile-pic-wrapper ">
                            <img src="/img/profile.png" alt="Profile" class="profile-pic">
                        </div>

                        <div>
                            <button class="edit-btn ">ÌîÑÎ°úÌïÑ Ìé∏Ïßë</button>
                            <div class="plane-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                                </svg>
                            </div>
                        </div>

                    </div>

                    <div class="flight-info-row">
                        <div class="airport-code"><span th:text="${session.userCountry}" class="font-weight-bold"></span></div>
                        <div class="flight-details">
                            <div class="detail-item ">
                                <div class="label">FLIGHT</div>
                                <div class="value">5</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">GATE</div>
                                <div class="value">2</div>
                            </div>
                        </div>
                    </div>



                    <h1 class="departure"
                        th:text="${session.userRegion != null ? session.userRegion : 'WHERE TO NEXT?'}">
                    </h1>
                    <p class="airline-name">Ìï≠Í≥µÏÇ¨ Ïù¥Î¶Ñ :<span th:text="${session.userNickName}" class="font-weight-bold"></span></p>

                    <div class="divider"></div>

                    <div class="bottom-section">
                        <div class="user-stats">
                            <h2 class="comment-title">ÌïúÎßàÎîî..</h2>
                            <div class="stat-row">
                                <span class="stat-label">Following</span>
                                <span class="stat-count">123</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Follower</span>
                                <span class="stat-count">456</span>
                            </div>
                        </div>
                        <div class="qr-code-wrapper">
                            <div class="qr-mock">
                                <div class="qr-eyes">üëÄ</div>
                                <div class="qr-num">3</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" onclick="closeModal()"></div>
    <div id="modal">
        <h3 id="modal-title">ÏÉàÎ°úÏö¥ ÌïÄ Ï†ïÎ≥¥</h3>
        <p id="modal-desc"></p>
        <button class="close-btn" onclick="closeModal()">Îã´Í∏∞</button>
    </div>
</div>
<script layout:fragment="script">
    let COUNTRY_MAP = {};

    $.ajax({
        url: "/country/list",
        type: "GET",
        dataType: "json",
        success: function (data) {
            $.each(data, function (_, country) {
                COUNTRY_MAP[country.countryCode] = country.countryName;
            });
            initMap();
        },
        error: function () {
            console.error("ÎÇòÎùº Î™©Î°ù Î°úÎî© Ïã§Ìå®");
        }
    });

    function initMap() {
        am5.ready(function () {

            const root = am5.Root.new("chartdiv");
            root.setThemes([am5themes_Animated.new(root)]);

            const chart = root.container.children.push(
                am5map.MapChart.new(root, {
                    panX: "rotateX",
                    panY: "rotateY",
                    projection: am5map.geoOrthographic(),
                    paddingBottom: 20,
                    paddingTop: 20,
                    paddingLeft: 20,
                    paddingRight: 20
                })
            );

            /* ===== Î∞îÎã§ ===== */
            const backgroundSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {})
            );

            backgroundSeries.mapPolygons.template.setAll({
                fill: am5.color(0xE5E5E5),
                fillOpacity: 0.5,
                strokeOpacity: 0
            });

            backgroundSeries.data.push({
                geometry: am5map.getGeoRectangle(90, 180, -90, -180)
            });

            /* ===== Í≤ΩÎèÑ/ÏúÑÎèÑ Í∑∏Î¶¨Îìú ===== */
            const graticuleSeries = chart.series.push(
                am5map.GraticuleSeries.new(root, {})
            );

            graticuleSeries.mapLines.template.setAll({
                stroke: am5.color(0x000000),
                strokeOpacity: 0.08,
                strokeWidth: 0.5
            });

            const polygonSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_worldLow
                })
            );

            polygonSeries.mapPolygons.template.setAll({
                fill: am5.color(0x5C85C6),
                stroke: am5.color(0xffffff),
                strokeWidth: 0.8,
                tooltipText: "{name}",
                interactive: true
            });

            polygonSeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x4A6FA5)
            });

            polygonSeries.events.on("datavalidated", function () {
                am5.array.each(polygonSeries.dataItems, function (item) {
                    const id = item.get("id");
                    if (COUNTRY_MAP[id]) {
                        item.set("name", COUNTRY_MAP[id]);
                    }
                });
            });

            const pointSeries = chart.series.push(
                am5map.MapPointSeries.new(root, {})
            );

            pointSeries.bullets.push(function () {
                const circle = am5.Circle.new(root, {
                    radius: 6,
                    fill: am5.color(0xff0000),
                    stroke: am5.color(0xffffff),
                    strokeWidth: 2,
                    cursorOverStyle: "pointer",
                    tooltipText: "ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ïÎ≥¥ Î≥¥Í∏∞"
                });

                circle.events.on("click", function (ev) {
                    const data = ev.target.dataItem.dataContext;
                    openModal(
                        data.title,
                        `ÏúÑÎèÑ: ${data.latitude.toFixed(2)}<br>Í≤ΩÎèÑ: ${data.longitude.toFixed(2)}`
                    );
                });

                return am5.Bullet.new(root, { sprite: circle });
            });

            chart.events.on("dblclick", function (ev) {
                const geoPoint = chart.invert(ev.point);
                if (!geoPoint) return;

                pointSeries.data.push({
                    geometry: {
                        type: "Point",
                        coordinates: [
                            geoPoint.longitude,
                            geoPoint.latitude
                        ]
                    },
                    title: "ÎÇ¥Í∞Ä Ï∂îÍ∞ÄÌïú Ïû•ÏÜå",
                    latitude: geoPoint.latitude,
                    longitude: geoPoint.longitude
                });
            });

            chart.animate({
                key: "rotationX",
                from: 0,
                to: 360,
                duration: 60000,
                loops: Infinity
            });

            chart.appear(1000, 100);
        });
    }

    function openModal(title, desc) {
        $("#modal-title").html(title);
        $("#modal-desc").html(desc);
        $("#modal, #modal-overlay").show();
    }

    function closeModal() {
        $("#modal, #modal-overlay").hide();
    }
</script>

</body>
</html>