<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_head}">

<div layout:fragment="fragment">
    <div id="chartdiv">
        <div class="profile-card-container">
            <div class="boarding-pass">
                <div class="top-stripe">
                    <img src="/img/top-stripe.png" alt="ÌîÑÎ°úÌïÑ Î®∏Î¶¨">
                </div>

                <div class="pass-content">
                    <div class="top-section">
                        <div class="profile-pic-wrapper">
                            <img id="navProfileImg"
                                 th:src="${session.userProfileImg != null && session.userProfileImg != '' ? session.userProfileImg : '/img/profile.png'}"
                                 class="profile-pic profile-sty">
                        </div>

                        <div>
                            <button class="edit-btn">ÌîÑÎ°úÌïÑ Ìé∏Ïßë</button>
                            <div class="plane-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="flight-info-row">
                        <div class="airport-code">
                            <span th:text="${session.userCountry}" class="font-weight-bold"></span>
                        </div>
                        <div class="flight-details">
                            <div class="detail-item">
                                <div class="label">FLIGHT</div>
                                <div class="value" th:text="${postCount}">0</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">GATE</div>
                                <div class="value" th:text="${wishlistCount}">0</div>
                            </div>
                        </div>
                    </div>

                    <h1 class="departure" th:if="${session.userRegion != null}"
                        th:text="${session.userRegion}"></h1>
                    <h1 class="departure" th:if="${session.userRegion == null}">WHERE TO NEXT?</h1>


                    <p class="airline-name">Ìï≠Í≥µÏÇ¨ Ïù¥Î¶Ñ :
                        <span th:text="${session.userNickName}" class="font-weight-bold"></span>
                    </p>

                    <div class="divider"></div>

                    <div class="bottom-section">
                        <div class="user-stats">
                            <div class="mt-1 flex">
                                <h3 class="profileWordText profileMessege mb-2"
                                   th:text="${session.userProfileWord != null ? session.userProfileWord : '-'}">-</h3>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Following</span>
                                <span class="stat-count">123</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Follower</span>
                                <span class="stat-count">456</span>
                            </div>
                        </div>
                        <div class="qr-code-wrapper">
                            <div class="qr-mock">
                                <div class="qr-eyes">üëÄ</div>
                                <div class="qr-num">3</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <th:block th:replace="mypage/countryList :: countryListPanel"></th:block>
    <th:block th:replace="mypage/countryList :: countryListScript"></th:block>

    <th:block th:replace="mypage/profile :: profilePanel"></th:block>
    <th:block th:replace="mypage/profile :: profileScript"></th:block>

    <th:block th:replace="mypage/wishlistList :: wishlistListPanel"></th:block>
    <th:block th:replace="mypage/wishlistList :: wishlistListScript"></th:block>


    <th:block th:replace="post/popup_detail :: PopupDetail"></th:block>
    <th:block th:replace="post/popup_detail :: PopupDetailScript"></th:block>

    <th:block th:replace="layouts/create :: createPopupScript"></th:block>
</div>


<!--<script layout:fragment="script">-->

<!--    let COUNTRY_MAP = {};-->
<!--    let COUNTRY_ID_MAP = {};-->

<!--    window.currentPostId = window.currentPostId || null;-->

<!--    $.ajax({-->
<!--        url: "/country/list",-->
<!--        type: "GET",-->
<!--        dataType: "json",-->
<!--        success: function (response) {-->
<!--            $.each(response, function (_, c) {-->
<!--                const meta = { id: c.id, name: c.countryName, en: c.countryNameEn };-->
<!--                COUNTRY_MAP[c.countryCode] = meta;-->
<!--                COUNTRY_ID_MAP[c.id] = meta;-->
<!--            });-->
<!--            initMap();-->
<!--        },-->
<!--        error: function () {-->
<!--            console.error("ÎÇòÎùº Î™©Î°ù Î°úÎî© Ïã§Ìå®");-->
<!--        }-->
<!--    });-->


<!--    function buildLocationText(p) {-->
<!--        let locationText = (p.locationText || "").toString().trim();-->

<!--        if (!locationText) {-->
<!--            const country = (p.countryName || p.country || p.countryCode || "").toString().trim();-->
<!--            const city = (p.cityName || p.city || "").toString().trim();-->
<!--            locationText = [country, city].filter(Boolean).join(" - ");-->
<!--        }-->

<!--        locationText = locationText.replace(/null/gi, "").replace(/\s+-\s+$/, "").trim();-->

<!--        return locationText;-->
<!--    }-->

<!--    function setModalBasicFields(p) {-->
<!--        const nickname = (p.nickName || "").toString();-->
<!--        $("#modalNickname").text(nickname);-->

<!--        const locationText = buildLocationText(p);-->
<!--        $("#modalLocationSidebar").text(locationText);-->
<!--        if (typeof adjustVerticalFont === "function") adjustVerticalFont();-->

<!--        $("#modalMusic").text((p.musicUrl || "").toString());-->

<!--        $("#modalLikeCount").text(p.likeCount != null ? p.likeCount : 0);-->

<!--        const liked = !!(p.isLike ?? p.like);-->

<!--        const $icon = $("#modalLikeIcon");-->
<!--        if (liked) {-->
<!--            $icon.removeClass("bi-heart text-dark").addClass("bi-heart-fill text-danger");-->
<!--        } else {-->
<!--            $icon.removeClass("bi-heart-fill text-danger").addClass("bi-heart text-dark");-->
<!--        }-->

<!--        const city = (p.cityName || "").toString().trim();-->
<!--        const place = (p.placeName || "").toString().trim();-->
<!--        const atmos = (p.atmosphere || "").toString().trim();-->

<!--        if (city || place || atmos) {-->
<!--            $("#modalCityName").text(city).toggle(!!city);-->
<!--            $("#modalPlaceName").text(place).toggle(!!place);-->
<!--            $("#modalAtmosphere").text(atmos).toggle(!!atmos);-->
<!--            $("#modalPlaceInfo").removeClass("hidden");-->
<!--        } else {-->
<!--            $("#modalPlaceInfo").addClass("hidden");-->
<!--        }-->

<!--    }-->


<!--    function initMap() {-->
<!--        am5.ready(function () {-->

<!--            const root = am5.Root.new("chartdiv");-->
<!--            root.setThemes([am5themes_Animated.new(root)]);-->

<!--            const chart = root.container.children.push(-->
<!--                am5map.MapChart.new(root, {-->
<!--                    panX: "rotateX",-->
<!--                    panY: "rotateY",-->
<!--                    projection: am5map.geoOrthographic(),-->
<!--                    paddingBottom: 20,-->
<!--                    paddingTop: 20,-->
<!--                    paddingLeft: 20,-->
<!--                    paddingRight: 20-->
<!--                })-->
<!--            );-->

<!--            const backgroundSeries = chart.series.push(-->
<!--                am5map.MapPolygonSeries.new(root, {})-->
<!--            );-->

<!--            backgroundSeries.mapPolygons.template.setAll({-->
<!--                fill: am5.color(0xE5E5E5),-->
<!--                fillOpacity: 0.5,-->
<!--                strokeOpacity: 0-->
<!--            });-->

<!--            backgroundSeries.data.push({-->
<!--                geometry: am5map.getGeoRectangle(90, 180, -90, -180)-->
<!--            });-->

<!--            const graticuleSeries = chart.series.push(-->
<!--                am5map.GraticuleSeries.new(root, {})-->
<!--            );-->

<!--            graticuleSeries.mapLines.template.setAll({-->
<!--                stroke: am5.color(0x000000),-->
<!--                strokeOpacity: 0.08,-->
<!--                strokeWidth: 0.5-->
<!--            });-->

<!--            const polygonSeries = chart.series.push(-->
<!--                am5map.MapPolygonSeries.new(root, {-->
<!--                    geoJSON: am5geodata_worldLow-->
<!--                })-->
<!--            );-->

<!--            polygonSeries.mapPolygons.template.setAll({-->
<!--                fill: am5.color(0x5C85C6),-->
<!--                stroke: am5.color(0xffffff),-->
<!--                strokeWidth: 0.8,-->
<!--                tooltipText: "{name}",-->
<!--                interactive: true-->
<!--            });-->

<!--            polygonSeries.mapPolygons.template.states.create("hover", {-->
<!--                fill: am5.color(0x4A6FA5)-->
<!--            });-->

<!--            polygonSeries.events.on("datavalidated", function () {-->
<!--                am5.array.each(polygonSeries.dataItems, function (item) {-->
<!--                    const code = item.get("id");-->
<!--                    if (COUNTRY_MAP[code]) item.set("name", COUNTRY_MAP[code].name);-->
<!--                });-->
<!--            });-->
<!--            polygonSeries.mapPolygons.template.events.on("click", function (ev) {-->
<!--                ignoreNextDocClick = true;-->

<!--                const dataItem = ev.target.dataItem;-->
<!--                if (!dataItem) return;-->

<!--                const code = dataItem.get("id");-->
<!--                const meta = COUNTRY_MAP[code];-->
<!--                if (!meta) return;-->

<!--                openCountryListPanel(meta);-->
<!--            });-->

<!--            polygonSeries.mapPolygons.template.events.on("dblclick", function (ev) {-->
<!--                const dataItem = ev.target.dataItem;-->
<!--                if (!dataItem) return;-->

<!--                const code = dataItem.get("id");-->
<!--                const meta = COUNTRY_MAP[code];-->
<!--                if (!meta) return;-->

<!--                const geoPoint = chart.invert(ev.point);-->
<!--                openCreatePostWithCountry(meta.id, geoPoint);-->
<!--            });-->

<!--            const pointSeries = chart.series.push(-->
<!--                am5map.MapPointSeries.new(root, {})-->
<!--            );-->

<!--            pointSeries.bullets.push(function () {-->
<!--                const circle = am5.Circle.new(root, {-->
<!--                    radius: 6,-->
<!--                    fill: am5.color(0xff0000),-->
<!--                    stroke: am5.color(0xffffff),-->
<!--                    strokeWidth: 2,-->
<!--                    cursorOverStyle: "pointer",-->
<!--                    tooltipText: "ÌÅ¥Î¶≠ÌïòÏó¨ Í≤åÏãúÎ¨º Î≥¥Í∏∞"-->
<!--                });-->

<!--                circle.events.on("click", function (ev) {-->
<!--                    const data = ev.target.dataItem.dataContext;-->
<!--                    if (!data || !data.postId) return;-->
<!--                    openPostDetailFromMap(data.postId);-->
<!--                });-->

<!--                return am5.Bullet.new(root, { sprite: circle });-->
<!--            });-->
<!--            const wishlistSeries = chart.series.push(-->
<!--                am5map.MapPointSeries.new(root, {})-->
<!--            );-->

<!--            wishlistSeries.bullets.push(function () {-->
<!--                const circle = am5.Circle.new(root, {-->
<!--                    radius: 7,-->
<!--                    fill: am5.color(0x7c3aed),-->
<!--                    stroke: am5.color(0xffffff),-->
<!--                    strokeWidth: 2,-->
<!--                    cursorOverStyle: "pointer",-->
<!--                    tooltipText: "ÏúÑÏãúÎ¶¨Ïä§Ìä∏"-->
<!--                });-->

<!--                circle.events.on("click", function (ev) {-->
<!--                    const data = ev.target.dataItem.dataContext;-->
<!--                    if (!data) return;-->

<!--                    const meta = data.countryId ? COUNTRY_ID_MAP[data.countryId] : null;-->
<!--                    if (!meta) {-->
<!--                        console.warn("ÏúÑÏãúÎ¶¨Ïä§Ìä∏ ÌïÄÏóê countryId/metaÍ∞Ä ÏóÜÏñ¥ Ìå®ÎÑêÏùÑ Ïó¥ Ïàò ÏóÜÏùå:", data);-->
<!--                        return;-->
<!--                    }-->

<!--                    openWishlistListPanel(meta);-->
<!--                });-->

<!--                return am5.Bullet.new(root, { sprite: circle });-->
<!--            });-->

<!--            loadPostMarkers(pointSeries);-->
<!--            loadWishlistMarkers(wishlistSeries);-->

<!--            chart.animate({-->
<!--                key: "rotationX",-->
<!--                from: 0,-->
<!--                to: 360,-->
<!--                duration: 60000,-->
<!--                loops: Infinity-->
<!--            });-->

<!--            chart.appear(1000, 100);-->
<!--        });-->
<!--    }-->
<!--    function loadWishlistMarkers(series) {-->
<!--        $.ajax({-->
<!--            url: "/mypage/api/wishlist/points",-->
<!--            type: "GET",-->
<!--            success: function (res) {-->
<!--                if (!res || !res.data) return;-->

<!--                const data = res.data.map(w => ({-->
<!--                    wishlistId: w.wishlistId,-->
<!--                    countryId: w.countryId,-->
<!--                    geometry: {-->
<!--                        type: "Point",-->
<!--                        coordinates: [w.longitude, w.latitude]-->
<!--                    }-->
<!--                }));-->

<!--                series.data.setAll(data);-->
<!--            }-->
<!--        });-->
<!--    }-->
<!--    function loadPostMarkers(pointSeries) {-->
<!--        $.ajax({-->
<!--            url: "/mypage/api/post/points",-->
<!--            type: "GET",-->
<!--            dataType: "json",-->
<!--            success: function (response) {-->
<!--                let list = [];-->
<!--                if (response && response.data) list = response.data;-->

<!--                const data = [];-->

<!--                for (let i = 0; i < list.length; i += 1) {-->
<!--                    const x = list[i];-->
<!--                    if (x.latitude == null || x.longitude == null) continue;-->

<!--                    data.push({-->
<!--                        postId: x.postId,-->
<!--                        geometry: { type: "Point", coordinates: [Number(x.longitude), Number(x.latitude)] }-->
<!--                    });-->
<!--                }-->

<!--                pointSeries.data.setAll(data);-->
<!--            },-->
<!--            error: function () {-->
<!--                console.error("Í≤åÏãúÎ¨º ÌïÄ Î°úÎî© Ïã§Ìå®");-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    function openPostDetailFromMap(postId) {-->
<!--        if (!postId) return;-->

<!--        $.ajax({-->
<!--            url: "/mypage/api/post/detail",-->
<!--            type: "GET",-->
<!--            data: { postId },-->
<!--            success: function (res) {-->
<!--                if (!res || res.result !== "success") {-->
<!--                    alert(res?.message || "Í≤åÏãúÎ¨º Ï°∞Ìöå Ïã§Ìå®");-->
<!--                    return;-->
<!--                }-->

<!--                const p = res.data;-->

<!--                window.currentPostId = p.id;-->
<!--                $("#modalPostId").val(p.id);-->

<!--                setModalBasicFields(p);-->

<!--                const $wrapper = $("#modalImageWrapper").empty();-->
<!--                if (p.imageList && p.imageList.length > 0) {-->
<!--                    p.imageList.forEach(img => {-->
<!--                        $wrapper.append(`-->
<!--            <div class="swiper-slide">-->
<!--              <img src="${img.imagePath}" class="w-[450px] h-full object-cover">-->
<!--            </div>-->
<!--          `);-->
<!--                    });-->
<!--                }-->

<!--                ModalSwiper.ensure();-->
<!--                const sw = ModalSwiper.get();-->
<!--                if (sw) {-->
<!--                    sw.update();-->
<!--                    sw.slideTo(0, 0);-->
<!--                }-->

<!--                const writerImg = safeProfileImg(p.profileImg);-->
<!--                $("#postDetailModal #modalWriterProfileImg")-->
<!--                    .attr("src", writerImg)-->
<!--                    .off("error")-->
<!--                    .on("error", function () { this.src = "/img/profile.png"; });-->

<!--                const nickname = (p.nickName || "User").toString();-->
<!--                const postContent = (p.contents || "").toString();-->

<!--                const $commentArea = $("#modalCommentList").empty();-->

<!--                const postWriterProfileHtml = renderProfileCircle(-->
<!--                    writerImg,-->
<!--                    "w-8 h-8",-->
<!--                    "border border-orange-200"-->
<!--                );-->

<!--                $commentArea.append(`-->
<!--        <div class="flex gap-3 mb-2">-->
<!--          ${postWriterProfileHtml}-->
<!--          <div class="space-y-1">-->
<!--            <p class="text-xs">-->
<!--              <span class="font-bold mr-2 text-sm">${nickname}</span>${postContent}-->
<!--            </p>-->
<!--            <p class="text-[10px] text-gray-400">Î∞©Í∏à Ï†Ñ</p>-->
<!--          </div>-->
<!--        </div>-->
<!--      `);-->

<!--                loadComments(p.id);-->

<!--                $("#postDetailModal").removeClass("hidden").addClass("flex");-->
<!--                setTimeout(() => {-->
<!--                    $("#postDetailModal > div").removeClass("scale-95").addClass("scale-100");-->
<!--                }, 10);-->

<!--                $("body").css("overflow", "hidden");-->
<!--                lucide.createIcons();-->
<!--            },-->
<!--            error: function () {-->
<!--                alert("Í≤åÏãúÎ¨º ÏÉÅÏÑ∏ Ï°∞Ìöå ÏóêÎü¨");-->
<!--            }-->
<!--        });-->
<!--    }-->


<!--    function openCreatePostWithCountry(countryId, geoPoint) {-->


<!--        if (geoPoint && geoPoint.latitude != null && geoPoint.longitude != null) {-->
<!--            $("#latitude").val(geoPoint.latitude);-->
<!--            $("#longitude").val(geoPoint.longitude);-->
<!--        }-->

<!--        $("#postCreateModal").modal({ backdrop: "static", keyboard: false });-->

<!--        $("#country option").each(function () {-->
<!--            if ($(this).data("id") === countryId) $(this).prop("selected", true);-->
<!--        });-->

<!--        $("#country").trigger("change");-->
<!--    }-->

<!--    function afterPostDetailDomInserted() {-->
<!--        fetchMyProfile(function (p) {-->
<!--            applyProfileToDetailUI(p);-->
<!--        });-->
<!--    }-->

<!--    function openPostDetailModal(postId) {-->

<!--        afterPostDetailDomInserted();-->

<!--        $("#postDetailModal").removeClass("hidden");-->
<!--    }-->

<!--</script>-->
</html>