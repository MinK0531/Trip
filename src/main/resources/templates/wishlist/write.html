<th:block th:fragment="WishlistPopup">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content p-4">
            <div class="flex justify-between items-center mb-3">
                <h5 id="wishModalTitle" class="fw-bold mb-0">위시리스트 추가</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>

            <input type="hidden" id="wishId">

            <label class="ticket-label">나라</label>
            <select id="wishCountryId" class="wish-input">
                <option value="" disabled selected>나라를 선택하세요</option>
            </select>

            <label class="ticket-label">도시 (선택)</label>
            <select id="wishCityName" class="wish-input" disabled>
                <option value="" disabled selected>도시명</option>
            </select>

            <label class="ticket-label">희망 시기</label>
            <input type="text" id="wishPeriod" class="wish-input" placeholder="언제 가고 싶나요?">

            <label class="ticket-label">희망 날짜 범위 선택 (선택)</label>
            <div class="wish-date-container">
                <input type="date" id="wishStartDate" class="wish-input">
                <input type="date" id="wishEndDate" class="wish-input">
            </div>

            <label class="ticket-label">메모 (선택)</label>
            <textarea id="wishMemo" class="wish-input" rows="3"></textarea>

            <input type="hidden" id="wishLatitude">
            <input type="hidden" id="wishLongitude">

            <div class="wish-footer mt-4 flex justify-end gap-2">
                <button type="button" class="btn btn-light border" data-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary px-4" id="wishSubmitBtn">저장</button>
            </div>
        </div>
    </div>
</th:block>
<th:block th:fragment="WishlistPopupScript">
    <script>
        (function () {
            const $country = $("#wishCountryId");
            const $city = $("#wishCityName");
            const $lat = $("#wishLatitude");
            const $lng = $("#wishLongitude");
            const $modal = $("#wishlistModal");

            let startPicker = null;
            let endPicker = null;

            function initDatePickersOnce() {
                if (startPicker && endPicker) return;

                startPicker = flatpickr("#wishStartDate", {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    onChange: function (selectedDates) {
                        if (!selectedDates.length) return;
                        const startDate = selectedDates[0];

                        endPicker.set("minDate", startDate);

                        if (endPicker.selectedDates.length && endPicker.selectedDates[0] < startDate) {
                            endPicker.clear();
                        }
                    }
                });

                endPicker = flatpickr("#wishEndDate", {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    onChange: function (selectedDates) {
                        if (!selectedDates.length) return;
                        const endDate = selectedDates[0];

                        startPicker.set("maxDate", endDate);

                        if (startPicker.selectedDates.length && startPicker.selectedDates[0] > endDate) {
                            startPicker.clear();
                            endPicker.set("minDate", "today");
                        }
                    }
                });
            }

            function resetDatePickers() {
                initDatePickersOnce();
                startPicker.clear();
                endPicker.clear();
                startPicker.set("minDate", "today");
                startPicker.set("maxDate", null);
                endPicker.set("minDate", "today");
            }

            function loadCountries() {
                if ($country.find("option").length > 1) return;

                $.ajax({
                    url: "/country/list",
                    type: "GET",
                    dataType: "json",
                    success: function (list) {
                        $country.html('<option value="" disabled selected>나라를 선택하세요</option>');
                        list.forEach(c => {
                            $("<option>")
                                .val(c.countryNameEn)
                                .text(c.countryName)
                                .attr("data-id", c.id)
                                .appendTo($country);
                        });
                    },
                    error: function () {
                        alert("나라 목록 로딩 실패");
                    }
                });
            }

            $country.on("change", function () {
                const countryName = $(this).val();
                if (!countryName) return;

                $city.prop("disabled", true).html('<option value="" disabled selected>도시명</option>');
                $lat.val(0.0);
                $lng.val(0.0);

                $.ajax({
                    url: "/city/list",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ country: countryName }),
                    success: function (response) {
                        const cities = response?.data?.cities || [];
                        const lat = response?.data?.latitude || 0.0;
                        const lng = response?.data?.longitude || 0.0;

                        cities.forEach(city => $("<option>").val(city).text(city).appendTo($city));
                        $city.prop("disabled", cities.length === 0);

                        $lat.val(lat);
                        $lng.val(lng);
                    },
                    error: function () {
                        alert("도시 목록 로딩 실패");
                    }
                });
            });

            $city.on("change", function () {
                const countryName = $country.val();
                const cityName = $(this).val();
                if (!cityName) return;

                $.ajax({
                    url: "/city/list",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ country: countryName, city: cityName }),
                    success: function (response) {
                        $lat.val(response?.data?.latitude || 0.0);
                        $lng.val(response?.data?.longitude || 0.0);
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            });

            $("#wishSubmitBtn").on("click.wishPopup", function () {
                    const wishId = $("#wishId").val();

                    const countryId = $("#wishCountryId option:selected").data("id");
                    const cityName = $("#wishCityName").val() || "";
                    const period = $("#wishPeriod").val().trim();

                    const startDate = $("#wishStartDate").val() || "";
                    const endDate = $("#wishEndDate").val() || "";
                    const memo = $("#wishMemo").val().trim();

                    const latitude = $("#wishLatitude").val() || "";
                    const longitude = $("#wishLongitude").val() || "";

                    if (!countryId) {
                        alert("나라를 선택하세요.");
                        return;
                    }
                    if (!period) {
                        alert("희망 시기를 입력하세요.");
                        return;
                    }
                    if (startDate && endDate && endDate < startDate) {
                        alert("끝 날짜는 시작 날짜보다 빠를 수 없습니다.");
                        return;
                    }

                    const formData = new FormData();
                    if (wishId) formData.append("wishId", wishId);
                    formData.append("countryId", countryId);
                    formData.append("cityName", cityName);
                    formData.append("period", period);
                    formData.append("startDate", startDate);
                    formData.append("endDate", endDate);
                    formData.append("memo", memo);
                    formData.append("latitude", latitude);
                    formData.append("longitude", longitude);

                    $.ajax({
                        type: "POST",
                        url: "/wishlist/create",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response && response.result === "success") {
                                location.reload();
                            } else {
                                alert("위시리스트 저장 실패");
                            }
                        },
                        error: function () {
                            alert("위시리스트 저장 에러");
                        }
                    });
                });

            $(function () {
                loadCountries();
                initDatePickersOnce();
            });

            $modal.on("show.bs.modal", function () {
                resetDatePickers();
            });

        })();
    </script>
    </th:block>
