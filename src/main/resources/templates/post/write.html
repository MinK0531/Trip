<th:block th:fragment="PostPopup">

    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 bg-transparent">
            <div class="ticket-wrapper">
                <div class="ticket-main mr-5">
                    <div class="ticket-container" >
                        <div class="ticket-left-upload ml-4 mb-5">
                            <div class="new-post-header">
                                <div class="ticket-plane-icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                                    </svg>
                                </div>
                                <span class="new-post-text mt-3">new post</span>
                            </div>

                            <div class="upload-main-content text-center" id="drop-zone">
                                <input type="file" id="image-input" class="d-none" multiple accept="image/*">

                                <div id="upload-placeholder" class="text-center">
                                    <i data-lucide="image" class="mb-2 image-upload-icon"></i>
                                    <p class="upload-text">사진을 여기에 끌어다 놓으세요</p>
                                    <button type="button" class="btn btn-instagram-style" id="selectImgeBtn">
                                        컴퓨터에서 선택
                                    </button>
                                </div>

                                <div id="image-preview-container"></div>
                                <div id="slider-dots" class="slider-dots"></div>
                            </div>
                        </div>
                        <div class="ticket-center-input mr-4">
                            <div class="top-stripe-head">
                                <img src="/img/top-stripe.png" alt="top-stripe">
                            </div>
                            <label class="ticket-label mt-4">내용</label>
                            <textarea id="contents" class="ticket-input" rows="4" placeholder="여행의 기록을 남겨보세요 (0/1000)"></textarea>

                            <label class="ticket-label">여행한 나라</label>
                            <select id="country" class="ticket-input">
                                <option value="" disabled selected>나라를 선택하세요</option>
                            </select>

                            <label class="ticket-label">음악 (선택)</label>
                            <input type="text" id="music" class="ticket-input" placeholder="추억의 음악을 찾아보세요">
                        </div>
                    </div>
                </div>
                <div class="ticket-stub mr-3">
                    <div class="d-flex justify-content-end">
                        <button type="button" class="close-ticket" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <p class="stub-title">추천하는 장소 (선택)</p>
                    <label class="ticket-label">여행한 도시</label>
                    <select id="city" class="ticket-input" disabled>
                        <option value="" disabled selected>도시명</option>
                    </select>
                    <label class="ticket-label">가게 이름</label>
                    <input type="text" id="place-name"  class="ticket-input" placeholder="맛집/명소">
                    <label class="ticket-label">분위기</label>
                    <input type="text" id="place-mood" class="ticket-input" placeholder="평화로운, 힙한 등">

                    <button class="btn-upload-blue">POST NOW</button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="latitude" name="latitude" value="0.0">
    <input type="hidden" id="longitude" name="longitude" value="0.0">

</th:block>
<th:block th:fragment="PostPopupScript">
    <script>
        $(function () {
            const $countrySelect = $("#country");
            const $citySelect = $("#city");
            const $latitude = $("#latitude");
            const $longitude = $("#longitude");

            $.ajax({
                url: "/country/list",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    $.each(data, function (_, c) {
                        $("<option>")
                            .val(c.countryNameEn)
                            .text(c.countryName)
                            .attr("data-id", c.id)
                            .appendTo($countrySelect);
                    });
                },
                error: function () {
                    console.error("나라 목록 로딩 실패");
                }
            });

            $countrySelect.on("change", function () {
                const countryName = $(this).val();

                $citySelect.html('<option value="" disabled selected>도시명</option>')
                    .prop("disabled", true);

                $.ajax({
                    url: "/city/list",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ country: countryName }),
                    success: function (res) {
                        const cities = res.data.cities || [];
                        cities.sort().forEach(city => {
                            $("<option>").val(city).text(city).appendTo($citySelect);
                        });
                        $citySelect.prop("disabled", cities.length === 0);

                        // 나라 좌표 자동 저장
                        $latitude.val(res.data.latitude || 0.0);
                        $longitude.val(res.data.longitude || 0.0);
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            });

            $citySelect.on("change", function () {
                const countryName = $countrySelect.val();
                const cityName = $(this).val();

                if (!cityName) return;

                $.ajax({
                    url: "/city/list",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ country: countryName, city: cityName }),
                    success: function (res) {
                        $latitude.val(res.data.latitude || 0.0);
                        $longitude.val(res.data.longitude || 0.0);
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            });
        });

    </script>

    <script>
        const selectedFiles = [];
        const $fileInput = $("#image-input");
        const $previewContainer = $("#image-preview-container");
        const $dotsContainer = $("#slider-dots");
        const $placeholder = $("#upload-placeholder");
        const $dropZone = $("#drop-zone");


        const getCurrentIndex = () => {
            const width = $previewContainer.width();
            return Math.round($previewContainer.scrollLeft() / width);
        };

        const scrollToIndex = (index) => {
            const width = $previewContainer.width();
            $previewContainer.stop().animate({
                scrollLeft: width * index
            }, 300);
        };

        const updateActiveDot = () => {
            const index = getCurrentIndex();
            $dotsContainer.find(".dot")
                .removeClass("active")
                .eq(index).addClass("active");
        };

        const updateUI = () => {
            if (selectedFiles.length > 0) {
                $placeholder.hide();
                $previewContainer.css("display", "flex");
                $dotsContainer.show();
                updateActiveDot();
            } else {
                $placeholder.show();
                $previewContainer.hide();
                $dotsContainer.hide().empty();
                $fileInput.val("");
            }
        };


        function handleFiles(files) {
            [...files].forEach(file => {
                if (!file.type.startsWith("image/")) {
                    alert("이미지 파일만 업로드 가능합니다.");
                    return;
                }

                selectedFiles.push(file);

                const reader = new FileReader();
                reader.onload = (e) => {
                    $previewContainer.append(`
                <div class="preview-item">
                    <img src="${e.target.result}">
                    <button type="button" class="remove-img-btn">&times;</button>
                </div>
            `);

                    $dotsContainer.append(`<div class="dot"></div>`);

                    updateUI();
                    scrollToIndex(selectedFiles.length - 1);
                };
                reader.readAsDataURL(file);
            });
        }


        $(document).on("click", "#selectImgeBtn, .image-upload-icon", () => {
            $fileInput.click();
        });

        $fileInput.on("change", e => handleFiles(e.target.files));

        $(document).on("click", ".remove-img-btn", function () {
            const $item = $(this).closest(".preview-item");
            const index = $item.index();

            selectedFiles.splice(index, 1);
            $item.remove();
            $dotsContainer.find(".dot").eq(index).remove();

            updateUI();
        });

        $previewContainer.on("scroll", updateActiveDot);

        $dotsContainer.on("click", ".dot", function () {
            scrollToIndex($(this).index());
        });

        $(document).on("keydown", function (e) {
            if (!$previewContainer.is(":visible")) return;
            if (selectedFiles.length === 0) return;

            const index = getCurrentIndex();

            if (e.key === "ArrowLeft" && index > 0) {
                scrollToIndex(index - 1);
            }

            if (e.key === "ArrowRight" && index < selectedFiles.length - 1) {
                scrollToIndex(index + 1);
            }
        });

        $dropZone.on("dragover", e => {
            e.preventDefault();
            $dropZone.addClass("drag-active");
        });

        $dropZone.on("dragleave", () =>
            $dropZone.removeClass("drag-active")
        );

        $dropZone.on("drop", e => {
            e.preventDefault();
            $dropZone.removeClass("drag-active");
            handleFiles(e.originalEvent.dataTransfer.files);
        });
    </script>




    <script>
        $(".btn-upload-blue").on("click", function() {
            const contents = $("#contents").val().trim();
            const countryNameEn = $("#country").val();
            const countryId = $("#country option:selected").data('id');
            const cityName = $("#city").val();
            const placeName = $("#place-name").val().trim();
            const musicUrl = $("#music").val().trim();
            const atmosphere = $("#place-mood").val().trim();

            if (selectedFiles.length === 0) {
                alert("최소 한 장의 사진을 등록해주세요.");
                return;
            }
            if (!contents) {
                alert("여행 기록 내용을 입력하세요.");
                $("#contents").focus();
                return;
            }
            if (!countryNameEn) {
                alert("나라를 선택하세요.");
                $("#country").focus();
                return;
            }

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append("images", file);
            });
            formData.append("contents", contents);
            formData.append("countryId", countryId);
            formData.append("countryNameEn", countryNameEn);
            formData.append("cityName", cityName || "");
            formData.append("musicUrl", musicUrl || "");
            formData.append("atmosphere", atmosphere || "");
            formData.append("placeName", placeName || "");
            formData.append("latitude", $("#latitude").val());
            formData.append("longitude", $("#longitude").val());

            $.ajax({
                type: "POST",
                url: "/post/write",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.result === "success") {
                        location.reload();
                    } else {
                        alert("작성 실패!");
                    }
                },
                error: function () {
                    alert("작성 에러!");
                }
            });
        });

    </script>
</th:block>