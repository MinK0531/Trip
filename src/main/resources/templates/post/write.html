<th:block th:fragment="PostPopup">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 bg-transparent">
            <div class="ticket-wrapper">
                <div class="ticket-main mr-5">
                    <div class="ticket-container">
                        <div class="ticket-left-upload ml-4 mb-5">

                            <div class="new-post-header">
                                <div class="ticket-plane-icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                                    </svg>
                                </div>
                                <span class="new-post-text mt-3">new post</span>
                            </div>

                            <div class="upload-main-content text-center" id="drop-zone">

                                <input type="file" id="image-input" class="d-none" multiple>

                                <div id="upload-placeholder" class="text-center">
                                    <i data-lucide="image" class="mb-2 image-upload-icon"></i>
                                    <p class="upload-text">사진을 여기에 끌어다 놓으세요</p>
                                    <img id="image-preview" class="d-none mt-2"/>
                                    <button type="button" class="btn btn-instagram-style" id="selectImageBtn">
                                        컴퓨터에서 선택
                                    </button>
                                </div>

                                <div id="swiper-wrapper-box" class="d-none">
                                    <div class="swiper post-swiper">
                                        <div class="swiper-wrapper" id="imagePreviewWrapper">
                                        </div>

                                        <div class="swiper-pagination"></div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="ticket-center-input mr-4">
                            <div class="top-stripe-head">
                                <img src="/img/top-stripe.png" alt="top-stripe">
                            </div>

                            <label class="ticket-label mt-4">내용</label>
                            <textarea id="contentsInput" class="ticket-input" rows="4"
                                      placeholder="여행의 기록을 남겨보세요 (0/1000)"></textarea>

                            <label class="ticket-label">여행한 나라</label>
                            <select id="countrySelect" class="ticket-input">
                                <option value="" disabled selected>나라를 선택하세요</option>
                            </select>

                            <label class="ticket-label">음악 (선택)</label>
                            <input type="text" id="musicInput" class="ticket-input" placeholder="추억의 음악을 찾아보세요">
                        </div>
                    </div>
                </div>

                <div class="ticket-stub mr-3">
                    <div class="d-flex justify-content-end">
                        <button type="button" class="close-ticket" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <p class="stub-title">추천하는 장소 (선택)</p>

                    <label class="ticket-label">여행한 도시</label>
                    <select id="cityNameSelect" class="ticket-input" disabled>
                        <option value="" disabled selected>도시명</option>
                    </select>

                    <label class="ticket-label">가게 이름</label>
                    <input type="text" id="placeNameInput" class="ticket-input" placeholder="맛집/명소">

                    <label class="ticket-label">분위기</label>
                    <input type="text" id="placeMoodInput" class="ticket-input" placeholder="평화로운, 힙한 등">

                    <button type="button" class="btn-upload-blue" id="uploadBtn">POST NOW</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="latitude" name="latitude" value="0.0">
    <input type="hidden" id="longitude" name="longitude" value="0.0">
</th:block>

<th:block th:fragment="PostPopupScript">
    <script>lucide.createIcons();</script>
    <script>
        (function () {

            window.postUploaderState = window.postUploaderState || {
                selectedFiles: []
                , existingImages: []
                , removedImageIds: []
                , postSwiper: null
            };

            function st() { return window.postUploaderState; }
            function files() { return st().selectedFiles; }
            function existing() { return st().existingImages; }
            function removed() { return st().removedImageIds; }

            function getSwiper() { return st().postSwiper; }
            function setSwiper(swiper) { st().postSwiper = swiper; }

            function syncInputFiles() {
                const data = new DataTransfer();
                const arr = files();
                for (let i = 0; i < arr.length; i++) data.items.add(arr[i]);

                const input = document.getElementById("image-input");
                if (input) input.files = data.files;
            }

            function toggleUploadUI() {
                const total = existing().length + files().length;

                if (total === 0) {
                    $("#swiper-wrapper-box").addClass("d-none");
                    $("#upload-placeholder").removeClass("d-none");
                    $("#imagePreviewWrapper").empty();
                    return;
                }

                $("#upload-placeholder").addClass("d-none");
                $("#swiper-wrapper-box").removeClass("d-none");
            }

            function rebuildSwiper() {
                const prev = getSwiper();
                if (prev != null) {
                    prev.destroy(true, true);
                    setSwiper(null);
                }

                const swiperEl = document.querySelector("#postCreateModal .post-swiper");
                if (!swiperEl) return;

                const paginationEl = swiperEl.querySelector(".swiper-pagination");

                const swiper = new Swiper(swiperEl, {
                    slidesPerView: 1,
                    spaceBetween: 0,
                    loop: false,
                    watchOverflow: true,
                    pagination: { el: paginationEl || null, clickable: true },
                    observer: true,
                    observeParents: true
                });

                setSwiper(swiper);
            }

            function renderAllSlides() {
                toggleUploadUI();

                const $wrapper = $("#imagePreviewWrapper").empty();

                existing().forEach(function (img) {
                    $wrapper.append(`
              <div class="swiper-slide" data-kind="existing" data-image-id="${img.id}">
                <div class="preview-item">
                  <img src="${img.imagePath}" class="preview-img">
                  <button type="button" class="remove-img-btn" data-kind="existing">&times;</button>
                </div>
              </div>
            `);
                });

                const newFiles = files();
                if (newFiles.length === 0) {
                    rebuildSwiper();
                    return;
                }

                let loaded = 0;
                for (let i = 0; i < newFiles.length; i++) {
                    const file = newFiles[i];
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        $wrapper.append(`
                  <div class="swiper-slide" data-kind="new" data-new-index="${i}">
                    <div class="preview-item">
                      <img src="${e.target.result}" class="preview-img">
                      <button type="button" class="remove-img-btn" data-kind="new">&times;</button>
                    </div>
                  </div>
                `);

                        loaded++;
                        if (loaded === newFiles.length) {
                            rebuildSwiper();

                            const sw = getSwiper();
                            if (sw) sw.slideTo(existing().length, 0);
                        }
                    };

                    reader.readAsDataURL(file);
                }
            }

            function addFiles(fileList) {
                if (!fileList || fileList.length === 0) return;

                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];

                    if (!file.type || !file.type.startsWith("image/")) {
                        alert("이미지만 선택 가능");
                        continue;
                    }
                    files().push(file);
                }

                syncInputFiles();
                renderAllSlides();
            }

            function loadExistingImages(postId) {
                st().existingImages = [];
                st().removedImageIds = [];

                if (!postId) {
                    renderAllSlides();
                    return;
                }

                $.ajax({
                    type: "GET"
                    , url: "/post/images"
                    , data: { postId: postId }
                    , success: function (response) {
                        const list = (response && response.data) ? response.data : [];
                        st().existingImages = list.map(function (x) {
                            return { id: x.id, imagePath: x.imagePath };
                        });
                        renderAllSlides();
                    }
                    , error: function () {
                        st().existingImages = [];
                        renderAllSlides();
                    }
                });
            }

            $("#postCreateModal").on("open-edit-post.postUploader", function (_e, data) {
                data = data || {};
                const postId = data.postId;

                $("#postCreateModal").attr("data-edit-post-id", postId || "");
                $("#uploadBtn").text("수정하기");

                $("#contentsInput").val(data.contents || "");
                $("#musicInput").val(data.musicUrl || "");
                $("#placeNameInput").val(data.placeName || "");
                $("#placeMoodInput").val(data.atmosphere || "");
                $("#latitude").val(data.latitude || 0.0);
                $("#longitude").val(data.longitude || 0.0);

                const countryId = data.countryId;
                const cityName = data.cityName || "";

                (function selectCountryThenCity() {
                    let retry = 40;

                    function tick() {
                        const $country = $("#countrySelect");
                        const $city = $("#cityNameSelect");

                        const $opt = $country.find("option").filter(function () {
                            return String($(this).data("id")) === String(countryId);
                        });

                        if ($opt.length) {
                            $opt.prop("selected", true);
                            $country.trigger("change");

                            let retryCity = 40;
                            (function tickCity() {
                                const hasCityOption = $city.find("option").filter(function () {
                                    return String($(this).val()) === String(cityName);
                                }).length > 0;

                                if (hasCityOption) {
                                    $city.val(cityName).trigger("change");
                                    return;
                                }

                                retryCity--;
                                if (retryCity <= 0) return;
                                setTimeout(tickCity, 100);
                            })();

                            return;
                        }

                        retry--;
                        if (retry <= 0) return;
                        setTimeout(tick, 100);
                    }

                    tick();
                })();
                files().length = 0;
                syncInputFiles();
                loadExistingImages(postId);
            });
            $(document).on("change.postUploader", "#image-input", function (e) {
                addFiles(e.target.files);
                $(this).val("");
            });

            $(document).on("click.selectImage", "#selectImageBtn", function () {
                $("#image-input").click();
            });

            $(document).on("click.removeImage", ".remove-img-btn", function () {
                const kind = String($(this).data("kind") || "");
                const $slide = $(this).closest(".swiper-slide");

                if (kind === "existing") {
                    const imageId = Number($slide.data("image-id"));
                    if (Number.isNaN(imageId)) return;

                    removed().push(imageId);
                    st().existingImages = existing().filter(function (x) { return x.id !== imageId; });

                    renderAllSlides();
                    return;
                }

                if (kind === "new") {
                    const newIndex = Number($slide.data("new-index"));
                    if (Number.isNaN(newIndex)) return;

                    files().splice(newIndex, 1);
                    syncInputFiles();
                    renderAllSlides();
                }
            });

            $(document).on("dragover.postUploader", "#drop-zone", function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass("drag-over");
            });

            $(document).on("dragleave.postUploader", "#drop-zone", function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass("drag-over");
            });

            $(document).on("drop.postUploader", "#drop-zone", function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass("drag-over");

                const dt = e.originalEvent.dataTransfer;
                if (!dt) return;

                addFiles(dt.files);
            });

            $(document).on("click.closeTicket", ".close-ticket", function () {
                files().length = 0;
                st().existingImages = [];
                st().removedImageIds = [];
                $("#postCreateModal").attr("data-edit-post-id", "");
                $("#uploadBtn").text("POST NOW");

                $("#image-input").val("");
                syncInputFiles();

                const prev = getSwiper();
                if (prev != null) {
                    prev.destroy(true, true);
                    setSwiper(null);
                }

                $("#imagePreviewWrapper").empty();
                $("#swiper-wrapper-box").addClass("d-none");
                $("#upload-placeholder").removeClass("d-none");
                $("#drop-zone").removeClass("drag-over");
            });

        })();
    </script>

    <script>
        (function () {
            const $country = $("#countrySelect");
            const $city = $("#cityNameSelect");
            const $lat = $("#latitude");
            const $lng = $("#longitude");

            function loadCountries() {
                if ($country.find("option").length > 1) return;

                $.ajax({
                    url: "/country/list",
                    type: "GET",
                    dataType: "json",
                    success: function (list) {
                        $country.html('<option value="" disabled selected>나라를 선택하세요</option>');
                        list.forEach(c => {
                            $("<option>")
                                .val(c.countryNameEn)
                                .text(c.countryName)
                                .attr("data-id", c.id)
                                .appendTo($country);
                        });
                    },
                    error: function(){
                         alert("나라 목록 로딩 실패")
                    }
                });
            }

            $country.on("change", function () {
                const countryName = $(this).val();
                if (!countryName) return;

                $city.prop("disabled", true)
                    .html('<option value="" disabled selected>도시명</option>');
                $lat.val(0.0);
                $lng.val(0.0);

                $.ajax({
                    url: "/city/list",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ country: countryName }),
                    success: function (response) {
                        const cities = response?.data?.cities || [];
                        const lat = response?.data?.latitude || 0.0;
                        const lng = response?.data?.longitude || 0.0;

                        cities.forEach(city => {
                            $("<option>").val(city).text(city).appendTo($city);
                        });

                        $city.prop("disabled", cities.length === 0);
                        $lat.val(lat);
                        $lng.val(lng);
                    },
                    error:function (){
                        alert("err")
                    }
                });
            });

            $city.on("change", function () {
                const countryName = $country.val();
                const cityName = $(this).val();
                if (!cityName) return;

                $.ajax({
                    url: "/city/list",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ country: countryName, city: cityName }),
                    success: function (response) {
                        $lat.val(response?.data?.latitude || 0.0);
                        $lng.val(response?.data?.longitude || 0.0);
                    },
                    error: err => console.error(err)
                });
            });

            loadCountries();
        })();
    </script>
    <script>
        $("#uploadBtn").on("click.postSubmit", function () {
            const $createModal = $("#postCreateModal");
            const postId = $createModal.attr("data-edit-post-id");
            const isEdit = !!postId;

            const contents = $("#contentsInput").val().trim();
            const files = window.postUploaderState?.selectedFiles || [];
            const countryId = $("#countrySelect option:selected").data("id");

            const musicUrl = $("#musicInput").val().trim() || "";
            const cityName = $("#cityNameSelect").val() || "";
            const placeName = $("#placeNameInput").val().trim() || "";
            const atmosphere = $("#placeMoodInput").val().trim() || "";
            const latitude = $("#latitude").val();
            const longitude = $("#longitude").val();


            if (!contents) {
                alert("내용을 입력하세요");
                return;
            }
            if (!countryId) {
                alert("나라를 선택하세요.");
                return;
            }
            if (!isEdit && files.length === 0) {
                alert("사진을 한 장 이상 선택하세요");
                return;
            }

            const formData = new FormData();
            formData.append("contents", contents);
            formData.append("countryId", countryId);
            formData.append("musicUrl", musicUrl);
            formData.append("cityName", cityName);
            formData.append("placeName", placeName);
            formData.append("atmosphere", atmosphere);
            formData.append("latitude", latitude);
            formData.append("longitude", longitude);

            if (isEdit) {
                formData.append("postId", postId);

                files.forEach(f => formData.append("imageFiles", f));

                const removedIds = window.postUploaderState?.removedImageIds || [];
                removedIds.forEach(id => formData.append("removeImageIds", id));
            } else {
                files.forEach(f => formData.append("images", f));
            }
            if(isEdit){
                $.ajax({
                    type: "PUT" ,
                    url: "/post/update",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.result === "success")
                            location.reload();
                        else {
                            alert("수정 실패");
                        }
                    },
                    error: function () {
                        alert("수정 에러 발생");
                    }
                });
            }else{
                $.ajax({
                    url: "/post/write",
                    type:"POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.result === "success")
                            location.reload();
                        else {
                            alert("작성 실패");
                        }
                    },
                    error: function () {
                        alert("작성 에러!");
                    }
                });
            }
        });
    </script>

</th:block>

