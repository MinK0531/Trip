<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_head}">

<div layout:fragment="fragment">
    <main class="max-w-2xl mx-auto px-4 py-20">
        <div class="space-y-6">

            <div th:if="${#lists.isEmpty(postList)}"
                 class="text-center text-gray-500">
                <i data-lucide="camera-off" class="w-12 h-12 mx-auto mb-4"></i>
                <p>아직 게시물이 없습니다. 첫 여행 기록을 남겨보세요!</p>
            </div>

            <div th:each="post : ${postList}"
                 class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">

                <div class="border-t border-gray-300 border-b relative h-20 flex items-center px-4 overflow-hidden">
                    <div class="flex items-center gap-3 z-10">
                        <div class="w-12 h-12 rounded-full border-2 border-gray-100 overflow-hidden bg-orange-100"></div>

                        <div>
                            <p class="font-bold text-lg"
                               th:text="${post.nickName}">User</p>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <i data-lucide="globe" class="w-3.5 h-3.5"></i>
                                <span th:text="${post.countryName}">나라</span>
                                <span class="text-xs"
                                      th:text="${#temporals.format(post.createdAt,'yyyy-MM-dd')}"></span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${(post.placeName != null and post.placeName != '') or (post.cityName != null and post.cityName != '') or (post.atmosphere != null and post.atmosphere != '')}"
                         class="absolute right-0 top-0 h-full w-1/2 bg-blue-50 border-l border-b border-blue-200 polygon">
                        <div class=" h-full flex flex-col justify-center pl-12 pr-4">

                            <div class="space-y-1 gap-1.5">
                                <div class="flex gap-1.5">
                                    <i data-lucide="map-pin" class="w-5 h-5 text-blue-600"></i>
                                    <p th:if="${post.cityName}"
                                       th:text="${post.cityName}"
                                       class="font-bold text-blue-900 text-sm"></p>
                                </div>
                                <p th:if="${post.placeName}"
                                   th:text="${post.placeName}"
                                   class="ml-3 text-blue-600 text-xs"></p>
                                <p th:if="${post.atmosphere}"
                                   th:text="${post.atmosphere}"
                                   class="ml-4 text-blue-500 text-[10px]"></p>
                                </div>
                        </div>
                    </div>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 z-20">
                        <i th:if="${post.userId == session.userId}"
                           class="bi bi-three-dots-vertical more-btn text-blue-600 cursor-pointer text-xl"
                           data-toggle="modal"
                           data-target="#moreModal"
                           th:data-post-id="${post.id}"></i>
                    </div>
                </div>

                <div class="relative bg-gray-50 aspect-square overflow-hidden">

                    <div th:if="${not #lists.isEmpty(post.imageList)}"
                         class="image-slider flex h-full overflow-x-auto snap-x snap-mandatory scrollbar-hide"
                         th:attr="data-post-id=${post.id}">

                        <div th:each="img : ${post.imageList}"
                             class="flex-none w-full h-full snap-center">
                            <img th:src="${img.imagePath}" class="w-full h-full object-cover" alt="post image">
                        </div>
                    </div>

                    <div th:if="${#lists.isEmpty(post.imageList)}"
                         class="w-full h-full flex flex-col items-center justify-center text-gray-300">
                        <i data-lucide="image-off" class="w-16 h-16 mb-2"></i>
                        <p class="text-sm">이미지가 없습니다</p>
                    </div>

                    <div th:if="${#lists.size(post.imageList) > 1}"
                         class="feed-dots absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1"
                         th:attr="data-post-id=${post.id}">
                        <div th:each="img, iter : ${post.imageList}"
                             class="dot"
                             th:classappend="${iter.index == 0} ? ' active' : ''"></div>
                    </div>
                </div>

                <div class="border-t border-gray-300  p-3 pl-1 pr-1 space-y-3 ">

                    <div class="flex justify-between items-center">
                        <div class="flex gap-3 items-center gap-1.5 transition-opacity">
                            <button type="button">
                                <i th:if="${post.isLike}"
                                   class="bi bi-heart-fill text-danger btn-like-icon unlike-btn"
                                   th:data-post-id="${post.id}"></i>

                                <i th:unless="${post.isLike}"
                                   class="bi bi-heart text-dark btn-like-icon icon-stroke-thick like-btn"
                                   th:data-post-id="${post.id}"></i>

                                <span class="count-text"
                                      th:text="${post.likeCount}">0</span>
                            </button>
                            <button type="button" class="open-post-detail ml-2 "
                                    th:data-post-id="${post.id}"
                                    th:data-nickname="${post.nickName}"
                                    th:data-location="|${post.countryName} - ${post.cityName}|"
                                    th:data-content="${post.contents}">
                                <i class="bi bi-chat text-dark btn-like-icon icon-stroke-thick"></i>                                <span class="count-text" th:text="${post.commentCount}">0</span>
                            </button>
                            <button type="button" class="ml-3">
                                <i class="bi bi-share text-dark btn-like-icon icon-stroke-thick"></i>
                            </button>
                            <button type="button" class="ml-3">
                                <i class="bi bi-send text-dark btn-like-icon icon-stroke-thick"></i>
                            </button>
                        </div>
                        <button type="button">
                            <i class="bi bi-bookmark text-dark btn-like-icon icon-stroke-thick"></i>
                        </button>
                    </div>

                    <div class="flex gap-2 text-m mt-3">
                        <span class="font-bold"
                              th:text="${post.nickName}">User</span>
                        <span th:text="${post.contents}">내용</span>
                    </div>

                    <div th:if="${post.musicUrl != null and post.musicUrl != ''}"
                         class="flex items-center gap-2 text-xs text-blue-600 bg-blue-50 px-3 py-2 rounded-lg">
                        <i data-lucide="music" class="w-4 h-4"></i>
                        <span th:text="${post.musicUrl}" class="truncate"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade create-choice-modal" id="moreModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body">
                        <button type="button" class="btn-choice">수정하기</button>
                        <button type="button" class="btn-choice">삭제하기</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <th:block th:replace="post/popup_detail :: PopupDetail"></th:block>

    <script>
        $(function () {
            $(".image-slider").each(function () {
                const $slider = $(this);
                const postId = $slider.data("post-id");
                const $dots = $(`.feed-dots[data-post-id="${postId}"] .dot`);

                if ($dots.length === 0) return;

                const getIndex = () => {
                    const scrollLeft = $slider.scrollLeft();
                    const width = $slider.get(0).offsetWidth; // outerWidth보다 정확
                    return Math.round(scrollLeft / width);
                };

                const scrollToIndex = (index) => {
                    const width = $slider.get(0).offsetWidth;
                    $slider.stop().animate({
                        scrollLeft: index * width
                    }, 300);
                };

                const updateDots = () => {
                    const index = getIndex();
                    $dots.removeClass("active");
                    $dots.eq(index).addClass("active");
                };

                $slider.on("scroll", updateDots);

                $dots.on("click", function () {
                    scrollToIndex($(this).index());
                });
            });
        });
        $(".like-btn").on("click", function() {

            let postId = $(this).data("post-id");

            $.ajax({
                type:"post"
                , url:"/post/like"
                , data:{"postId":postId}
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("좋아요 실패!");
                    }
                }
                , error:function() {
                    alert("좋아요 에러!");
                }

            });

        });
        $(".unlike-btn").on("click", function() {

            let postId = $(this).data("post-id");

            $.ajax({
                type:"delete"
                , url:"/post/unlike"
                , data:{"postId":postId}
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("좋아요 취소 실패!");
                    }
                }
                , error:function() {
                    alert("좋아요 취소 에러!");
                }

            });

        });

    </script>

    <th:block th:replace="post/popup_detail :: PopupDetailScript"></th:block>

</div>
</html>
