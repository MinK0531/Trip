<th:block th:fragment="PopupDetail">
    <div id="postDetailModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/70 p-4">
        <div class="modal-content-fixed scale-95 transition-transform duration-300 relative">

            <div class="flex">
                <div class="ticket-sidebar flex flex-col items-center text-white">
                    <i data-lucide="plane" class="w-10 h-10 rotate-45 text-white" fill="currentColor"></i>
                    <div class="barcode-deco flex flex-col">
                        <div class="flex justify-center gap-[2px] mb-2">
                            <img src="/img/barcodeWW.png">
                        </div>
                    </div>
                    <div class="vertical-location" id="modalLocationSidebar">대한민국 - JEJU</div>
                    <div class="barcode-deco flex flex-col">
                        <div class="flex justify-center gap-[2px] mb-1">
                            <img src="/img/barcodeW.png">
                        </div>
                    </div>
                </div>
                <div class="relative bg-black flex-shrink-0 group img">
                    <div id="modalImageContainer" class="flex h-full overflow-x-auto snap-x snap-mandatory scrollbar-hide">
                    </div>
                    <div id="modalImageDots" class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-1.5 z-10"></div>
                </div>

                <div class="flex-1 flex flex-col bg-white h-full min-w-0">
                    <div class="h-9 blue shrink-0"></div>

                    <div class="p-3 ml-2 border-b flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur-md z-10 shrink-0">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-orange-100 to-orange-200 border border-orange-200 overflow-hidden flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 text-orange-400"></i>
                            </div>
                            <div>
                                <p id="modalNickname" class="font-bold text-sm text-gray-900"></p>
                                <p class="text-[10px] text-gray-400 flex items-center gap-1 before:content-['•'] before:mr-1">
                                    <i data-lucide="music" class="w-3 h-3 text-blue-500"></i>
                                    <span id="modalMusic">라라랜드 - another day of sun</span>
                                </p>
                            </div>
                        </div>
                        <button id="closeModal" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                            <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                        </button>
                    </div>

                    <div id="modalCommentList" class="flex-1 overflow-y-auto p-3 space-y-5 custom-scroll bg-gray-50/30">
                    </div>

                    <div class="p-3 border-t bg-white shrink-0">
                        <div class="flex items-center gap-3">
                            <input type="hidden" id="modalPostId">
                            <div class="w-9 h-9 rounded-full bg-orange-100 border border-orange-200 overflow-hidden flex items-center justify-center shrink-0">
                                <i data-lucide="user" class="w-5 h-5 text-orange-400"></i>
                            </div>
                            <div class="flex-1 flex flex-col bg-gray-50 border border-gray-100 px-4 py-2 rounded-2xl focus-within:border-blue-300 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                                <div id="replyIndicator" class="hidden flex justify-between items-center mb-1">
                                    <span id="replyTargetName" class="text-[10px] text-blue-500 font-bold"></span>
                                    <button type="button" onclick="cancelReplyMode()" class="text-[10px] text-gray-400 hover:text-red-500">취소</button>
                                </div>
                                <input type="text" id="commentInput" placeholder="당신의 흔적을 남겨보세요..."
                                       class="bg-transparent text-sm outline-none placeholder:text-gray-400">
                            </div>
                            <button id="btnCommentSubmit" class="text-blue-500 font-bold text-sm hover:text-blue-700 transition-colors px-2 shrink-0">게시</button>
                        </div>
                    </div>

                    <div class="h-9 blue  shrink-0"></div>
                </div>
            </div>
        </div>
    </div>
</th:block>
<th:block th:fragment="PopupDetailScript">

    <script>

        let currentPostId = null;
        let selectedParentId = null;

        function adjustVerticalFont() {
            const el = document.getElementById("modalLocationSidebar");
            if (!el) return;
            const textLength = el.innerText.trim().length;
            let fontSize = 1.1;
            if (textLength > 10) fontSize = 1.0;
            if (textLength > 13) fontSize = 0.9;
            if (textLength > 16) fontSize = 0.7;
            if (textLength > 20) fontSize = 0.6;
            if (textLength > 25) fontSize = 0.5;
            if (textLength > 30) fontSize = 0.4;
            el.style.fontSize = fontSize + "rem";
        }

        function cancelReplyMode() {
            selectedParentId = null;
            $("#replyIndicator").addClass("hidden");
            $("#commentInput").val("").attr("placeholder", "당신의 흔적을 남겨보세요...");
        }

        function groupComments(comments) {
            const map = {};
            const roots = [];

            comments.forEach(c => {
                map[c.id] = { ...c, replies: [] };
                if (!c.parentId) {
                    roots.push(map[c.id]);
                }
            });

            comments.forEach(c => {
                if (c.parentId && map[c.parentId]) {
                    map[c.parentId].replies.push(map[c.id]);
                }
            });

            return roots;
        }


        function renderComments(comments) {
            const $list = $("#modalCommentList");

            $list.find(".comment-item-container").remove();

            const grouped = groupComments(comments);

            grouped.forEach(parent => {
                let parentHtml = `
                <div class="comment-item-container space-y-2" data-id="${parent.id}">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-orange-100 border border-orange-200 flex-shrink-0 flex items-center justify-center">
                             <i data-lucide="user" class="w-4 h-4 text-orange-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs">
                                <span class="font-bold mr-2 text-sm">${parent.nickName}</span>
                                ${parent.deleted ? '<span class="italic text-gray-400">삭제된 댓글입니다.</span>' : parent.comments}
                            </p>
                            <div class="flex gap-4 mt-1 items-center">
                                <span class="text-[10px] text-gray-400">방금 전</span>
                                ${!parent.deleted ? `
                                <button class="btn-reply text-[10px] font-bold text-gray-500 hover:text-blue-500"
                                    data-id="${parent.id}"
                                    data-nick="${parent.nickName}">
                                    답글 달기
                                </button>` : ``}
                            </div>
                        </div>
                    </div>`;

                if (parent.replies.length > 0) {
                    parentHtml += `
                    <button class="btn-toggle-replies ml-11 text-[10px] text-gray-500 font-bold flex items-center gap-1" data-id="${parent.id}">
                        ── 답글 ${parent.replies.length}개 보기
                    </button>`;
                }

                parent.replies.forEach(reply => {
                    parentHtml += `
                    <div class="reply-item hidden flex gap-3 ml-11 mt-2" data-parent="${parent.id}">
                        <div class="w-7 h-7 rounded-full bg-gray-100 border flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="user" class="w-3 h-3 text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs">
                                <span class="font-bold mr-2">${reply.nickName}</span>
                                ${reply.comments}
                            </p>
                            <div class="text-[10px] text-gray-400 mt-1">방금 전</div>
                        </div>
                    </div>`;
                });

                parentHtml += `</div>`;
                $list.append(parentHtml);
            });

            lucide.createIcons();
        }

        function loadComments(postId) {
            $.ajax({
                url: "/post/comment/list",
                type: "GET",
                data: { postId: postId },
                success: function(res) {
                    renderComments(res);
                },
                error: function() {
                    console.error("댓글 로드 실패");
                }
            });
        }


        $(function() {
            $(document).on("click", ".bi-chat", function() {
                const $card = $(this).closest(".bg-white.rounded-xl");
                currentPostId = $card.find(".image-slider").data("post-id");

                const nickname = $card.find("p.font-bold").first().text();
                const country = $card.find(".flex.items-center.gap-2.text-sm span:first-of-type").text();
                const city = $card.find(".text-blue-900.text-sm").text() || "";
                const music = $card.find(".music-info-text").text() || "라라랜드 - another day of sun";
                const postContent = $card.find(".flex.gap-2.text-m span:last-child").text();

                $("#modalNickname").text(nickname);
                $("#modalLocationSidebar").text(`${country} ${city ? '- ' + city : ''}`);
                $("#modalMusic").text(music);
                adjustVerticalFont();

                const $images = $card.find(".image-slider img");
                const $container = $("#modalImageContainer").empty();
                const $dots = $("#modalImageDots").empty();

                $images.each(function(i) {
                    const src = $(this).attr("src");
                    $container.append(`<img src="${src}" class="w-[450px] h-full object-cover snap-center flex-shrink-0">`);
                    $dots.append(`<div class="modal-dot ${i === 0 ? 'active' : ''}"></div>`);
                });

                const $commentArea = $("#modalCommentList").empty();
                $commentArea.append(`
                    <div class="flex gap-3 mb-6">
                        <div class="w-8 h-8 rounded-full bg-orange-100 flex-shrink-0 border border-orange-200 flex items-center justify-center">
                            <i data-lucide="user" class="w-4 h-4 text-orange-400"></i>
                        </div>
                        <div class="space-y-1">
                            <p class="text-xs"><span class="font-bold mr-2 text-sm">${nickname}</span>${postContent}</p>
                            <p class="text-[10px] text-gray-400">방금 전</p>
                        </div>
                    </div>
                `);

                loadComments(currentPostId);

                $("#postDetailModal").removeClass("hidden").addClass("flex");
                setTimeout(() => {
                    $("#postDetailModal > div").removeClass("scale-95").addClass("scale-100");
                }, 10);
                $("body").css("overflow", "hidden");
                lucide.createIcons();
            });

            $("#closeModal, #postDetailModal").on("click", function(e) {
                if (e.target === this || $(e.target).closest("#closeModal").length) {
                    $("#postDetailModal > div").addClass("scale-95").removeClass("scale-100");
                    setTimeout(() => {
                        $("#postDetailModal").addClass("hidden").removeClass("flex");
                        $("body").css("overflow", "auto");
                        cancelReplyMode();
                    }, 200);
                }
            });

            $("#modalImageContainer").on("scroll", function() {
                const index = Math.round($(this).scrollLeft() / 450);
                $(".modal-dot").removeClass("active").eq(index).addClass("active");
            });

            $("#btnCommentSubmit").on("click", function() {
                const content = $("#commentInput").val().trim();
                if (!content) {
                    alert("내용을 입력해주세요.");
                    return;
                }

                $.ajax({
                    url: "/post/comment/write",
                    type: "POST",
                    data: {
                        postId: currentPostId,
                        comments: content,
                        parentId: selectedParentId
                    },
                    success: function(res) {
                        if (res.result === "success") {
                            cancelReplyMode();
                            loadComments(currentPostId);
                        } else {
                            alert("댓글 등록에 실패했습니다.");
                        }
                    }
                });
            });

            $(document).on("click", ".btn-reply", function() {
                selectedParentId = $(this).data("id");
                const nick = $(this).data("nick");
                $("#replyTargetName").text(`@${nick}님에게 답글 남기는 중`);
                $("#replyIndicator").removeClass("hidden");
                $("#commentInput").focus();
            });

            $(document).on("click", ".btn-toggle-replies", function() {
                const parentId = $(this).data("id");
                const $replies = $(`.reply-item[data-parent='${parentId}']`);
                const isHidden = $replies.first().hasClass("hidden");

                $replies.toggleClass("hidden");
                $(this).text(isHidden ? "── 답글 접기" : `── 답글 ${$replies.length}개 보기`);
            });
        });
        $(".like-btn").on("click", function() {

            let postId = $(this).data("post-id");

            $.ajax({
                type:"post"
                , url:"/comment/like"
                , data:{"commentId": commentId}
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("좋아요 실패!");
                    }
                }
                , error:function() {
                    alert("좋아요 에러!");
                }

            });

        });
        $(".unlike-btn").on("click", function() {

            let postId = $(this).data("post-id");

            $.ajax({
                type:"delete"
                , url:"/comment/unlike"
                , data:{"commentId": commentId}
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("좋아요 취소 실패!");
                    }
                }
                , error:function() {
                    alert("좋아요 취소 에러!");
                }

            });

        });
    </script>
</th:block>