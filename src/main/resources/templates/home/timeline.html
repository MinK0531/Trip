<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_head}">

<body>
<div layout:fragment="fragment">

    <main class="max-w-2xl mx-auto px-4 py-20">
        <div class="space-y-6">

            <div th:if="${feedList == null or #lists.isEmpty(feedList)}"
                 class="text-center text-gray-500">
                <i data-lucide="camera-off" class="w-12 h-12 mx-auto mb-4"></i>
                <p>아직 게시물이 없습니다. 첫 여행 기록을 남겨보세요!</p>
            </div>

            <div th:if="${feedList != null}" th:each="item : ${feedList}">
                <th:block th:if="${item != null}"
                          th:switch="${item.type != null ? item.type.name() : 'NONE'}">

                    <th:block th:case="'POST'"
                              th:replace="post/post_card :: PostCard(post=${item.post})">
                    </th:block>

                    <th:block th:case="'WISHLIST'"
                              th:replace="wishlist/wishlist_card :: WishlistCard(wishlist=${item.wishlist})">
                    </th:block>

                </th:block>
            </div>

        </div>
        <div class="modal fade create-choice-modal" id="moreModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body">
                        <button type="button" class="btn-choice edit-post-btn d-none">게시물 수정</button>
                        <button type="button" class="btn-choice delete-post-btn d-none">게시물 삭제</button>

                        <button type="button" class="btn-choice edit-wishlist-btn d-none">위시리스트 수정</button>
                        <button type="button" class="btn-choice delete-wishlist-btn d-none">위시리스트 삭제</button>


                    </div>
                </div>
            </div>
        </div>
    </main>
    <th:block th:replace="post/popup_detail :: PopupDetail"></th:block>
    <script>lucide.createIcons();</script>
    <script>
        $(document).on("click", ".more-btn", function () {
            $(".edit-post-btn, .delete-post-btn, .edit-wishlist-btn, .delete-wishlist-btn").addClass("d-none");

            const $btn = $(this);
            const $modal = $("#moreModal");
            const type = String($btn.data("type") || "").toUpperCase() || ($btn.data("wishlist-id") ? "WISHLIST" : "POST");
            $modal.attr("data-type", type);

            if (type === "WISHLIST") {
                $(".edit-wishlist-btn, .delete-wishlist-btn").removeClass("d-none");

                $modal.attr({
                    "data-wishlist-id": $btn.data("wishlist-id") || "",
                    "data-country-id": $btn.data("country-id") || "",
                    "data-city-name": $btn.data("city-name") || "",
                    "data-period": $btn.data("period") || "",
                    "data-start-date": $btn.data("start-date") || "",
                    "data-end-date": $btn.data("end-date") || "",
                    "data-memo": $btn.data("memo") || "",
                    "data-latitude": $btn.data("latitude") || 0.0,
                    "data-longitude": $btn.data("longitude") || 0.0
                });
            } else {
                $(".edit-post-btn, .delete-post-btn").removeClass("d-none");

                $modal.attr({
                    "data-post-id": $btn.data("post-id") || "",
                    "data-contents": $btn.data("contents") || "",
                    "data-country-id": $btn.data("country-id") || "",
                    "data-city-name": $btn.data("city-name") || "",
                    "data-place-name": $btn.data("place-name") || "",
                    "data-atmosphere": $btn.data("atmosphere") || "",
                    "data-music-url": $btn.data("music-url") || ""
                });
            }

            $("#moreModal").modal("show");
        });
    </script>
    <script>
        $(".delete-post-btn").on("click", function () {
            const postId = $("#moreModal").attr("data-post-id");

            if (!postId) {
                alert("postId 없음");
                return;
            }

            $.ajax({
                type: "DELETE",
                url: "/post/remove",
                data: { "postId":postId },
                success: function (response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("게시물 삭제 실패!");
                    }
                },
                error: function () {
                    alert("게시물 삭제 에러");
                }
            });
        });
        $(".delete-wishlist-btn").on("click", function () {
            const wishlistId = $("#moreModal").attr("data-wishlist-id");

            if (!wishlistId) {
                alert("wishlistId 없음");
                return;
            }

            $.ajax({
                type: "DELETE",
                url: "/wishlist/remove",
                data: { wishlistId: wishlistId },
                success: function (response) {
                    if (response.result === "success") {
                        location.reload();
                    } else {
                        alert("위시리스트 삭제 실패!");
                    }
                },
                error: function () {
                    alert("위시리스트 삭제 에러");
                }
            });
        });


        $(".like-btn").on("click", function() {
            let postId = $(this).data("post-id");
            $.ajax({
                type:"POST"
                , url:"/post/like"
                , data:{"postId":postId}
                , success:function(response)
                {
                    if(response.result == "success") {
                        location.reload();
                    }
                    else { alert("좋아요 실패!");
                    }
                }
                , error:function() {
                    alert("좋아요 에러!");
                }
            });
        });
        $(".unlike-btn").on("click", function() {
            let postId = $(this).data("post-id");
            $.ajax({
                type:"DELETE"
                , url:"/post/unlike"
                , data:{"postId":postId}
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("좋아요 취소 실패!");
                    }
                }
                , error:function() {
                    alert("좋아요 취소 에러!");
                }
            });
        });
        $(document).on("click", ".edit-post-btn", function () {
            const $m = $("#moreModal");
            const data = {
                postId: $m.attr("data-post-id"),
                contents: $m.attr("data-contents"),
                countryId: $m.attr("data-country-id"),
                cityName: $m.attr("data-city-name"),
                placeName: $m.attr("data-place-name"),
                atmosphere: $m.attr("data-atmosphere"),
                musicUrl: $m.attr("data-music-url")
            };

            $("#moreModal").modal("hide");

            setTimeout(function () {
                $("#postCreateModal").modal({ backdrop: "static", keyboard: false });
                $("#postCreateModal").trigger("open-edit-post", [data]);
            }, 150);
        });
    </script>
        <script>
            function initFeedSwipers() {
                document.querySelectorAll(".feed-swiper").forEach(function (el) {
                    if (el.dataset.swiperInited === "1") return;
                    el.dataset.swiperInited = "1";

                    const paginationEl = el.querySelector(".swiper-pagination");

                    new Swiper(el, {
                        slidesPerView: 1,
                        spaceBetween: 0,
                        loop: false,
                        pagination: { el: paginationEl || null, clickable: true },
                        observer: true,
                        observeParents: true
                    });
                });
            }

            document.addEventListener("DOMContentLoaded", initFeedSwipers);
    </script>
    <th:block th:replace="post/popup_detail :: PopupDetailScript"></th:block>

</div>
</body>
</html>
