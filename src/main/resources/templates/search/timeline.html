<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_head}">

<div layout:fragment="fragment">
    <main class="bg-gray-50 pt-16">
        <div id="app" class="max-w-3xl mx-auto px-4 py-8">

            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-6 mb-8 sticky top-20 z-40">
                <div class="relative mb-6">
                    <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input
                            type="text"
                            id="searchInput"
                            class="w-full pl-14 pr-6 h-14 bg-gray-50 border border-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all text-lg"
                            placeholder="아이디, 게시물, 나라 검색..."
                    >
                </div>
                <div class="flex bg-gray-100 p-1.5 rounded-2xl" id="tabContainer">
                    <button data-tab="all" class="tab-btn flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold rounded-xl transition-all bg-white shadow-md text-blue-600">
                        <i data-lucide="search" class="w-4 h-4 fill-blue-600/10"></i> 전체
                    </button>
                    <button data-tab="users" class="tab-btn flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold rounded-xl transition-all text-gray-500 hover:text-gray-700">
                        <i data-lucide="user" class="w-4 h-4"></i> 사용자
                    </button>
                    <button data-tab="countries" class="tab-btn flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold rounded-xl transition-all text-gray-500 hover:text-gray-700">
                        <i data-lucide="globe" class="w-4 h-4"></i> 나라
                    </button>
                </div>
            </div>

            <div id="resultArea" class="space-y-6 pb-20">
                <div id="emptyState" class="text-center py-32">
                    <p class="text-gray-300 text-xl font-medium">검색어를 입력해주세요</p>
                </div>

                <div id="searchResults" class="hidden">
                    <div id="userSection" class="mb-10 hidden">
                        <h3 class="text-sm font-bold text-gray-400 mb-4 px-2 uppercase tracking-wider">Users</h3>
                        <div id="userList" class="grid gap-3"></div>
                    </div>

                    <div id="postSection" class="hidden">
                        <h3 class="text-sm font-bold text-gray-400 mb-4 px-2 uppercase tracking-wider">Posts & Countries</h3>
                        <div id="postList" class="grid gap-6"></div>
                    </div>

                    <div id="noResults" class="hidden text-center py-20 bg-white rounded-3xl border border-dashed border-gray-200">
                        <i data-lucide="search-x" class="w-12 h-12 text-gray-200 mx-auto mb-4"></i>
                        <p class="text-gray-400">검색 결과가 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <th:block th:replace="post/popup_detail :: PopupDetail"></th:block>
    <th:block th:replace="post/popup_detail :: PopupDetailScript"></th:block>
</div>

<th:block layout:fragment="script">
    <script>
        $(document).ready(function () {

            let searchQuery = "";
            let searchType = "all"; // all | users | countries
            let timer = null;

            // -------------------------
            // utils
            // -------------------------
            function escapeHtml(str) {
                if (str == null) return "";
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function safeProfile(path) {
                if (!path || String(path).trim() === "") return "/img/profile.png";
                return String(path);
            }

            function fmtDateYYYYMMDD(v) {
                if (!v) return "";
                const s = String(v);
                return s.length >= 10 ? s.slice(0, 10) : s;
            }

            // -------------------------
            // api
            // -------------------------
            function apiSearch(keyword, tab) {
                return $.ajax({
                    url: "/search",
                    method: "GET",
                    data: { keyword: keyword, tab: tab },
                    dataType: "json"
                });
            }

            // ✅ 네가 쓰는 엔드포인트로 통일
            function apiLike(postId) {
                return $.ajax({
                    url: "/post/like",
                    method: "POST",
                    data: { postId: postId },
                    dataType: "json"
                });
            }

            function apiUnlike(postId) {
                return $.ajax({
                    url: "/post/unlike",
                    method: "DELETE",
                    data: { postId: postId },
                    dataType: "json"
                });
            }

            // -------------------------
            // render
            // -------------------------
            function renderPostCardLike(p) {
                const profileSrc = safeProfile(p.profileImg);
                const nick = escapeHtml(p.nickName || "User");
                const countryName = escapeHtml(p.countryName || "");
                const cityName = escapeHtml(p.cityName || "");
                const placeName = escapeHtml(p.placeName || "");
                const atmosphere = escapeHtml(p.atmosphere || "");
                const contents = escapeHtml(p.contents || "");
                const createdAt = p.createdAt ? escapeHtml(fmtDateYYYYMMDD(p.createdAt)) : "";

                const images = (p.imageList && p.imageList.length > 0)
                    ? p.imageList.map(img => (img && img.imagePath) ? String(img.imagePath) : null).filter(Boolean)
                    : [];

                const likeCount = (p.likeCount != null) ? p.likeCount : 0;
                const commentCount = (p.commentCount != null) ? p.commentCount : 0;

                // ✅ 서버에서 isLike가 오면 "처음부터 fill" 된다
                const liked = !!(p.isLike ?? p.like ?? p.liked);

                const swiperId = `searchFeedSwiper-${p.id}`;

                return `
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">

            <div class="border-t border-gray-300 border-b relative h-20 flex items-center px-4 overflow-hidden">
              <div class="flex items-center gap-3 z-10">
                <div class="w-12 h-12 rounded-full border-2 border-gray-100 overflow-hidden bg-orange-100">
                  <img src="${profileSrc}"
                       alt="Profile"
                       class="w-full h-full object-cover postcard-profile-img">
                </div>

                <div>
                  <p class="font-bold text-lg">${nick}</p>

                  <div class="flex items-center gap-2 text-sm text-gray-500">
                    <i data-lucide="globe" class="w-3.5 h-3.5"></i>
                    <span>${countryName}</span>
                    ${createdAt ? `<span class="text-xs">${createdAt}</span>` : ``}
                  </div>
                </div>
              </div>

              ${(placeName || cityName || atmosphere) ? `
                <div class="absolute right-0 top-0 h-full w-1/2 bg-blue-50 border-l border-b border-blue-200 polygon">
                  <div class="h-full flex flex-col justify-center pl-12 pr-4">
                    <div class="space-y-1 gap-1.5">
                      <div class="flex gap-1.5">
                        <i data-lucide="map-pin" class="w-5 h-5 text-blue-600"></i>
                        ${cityName ? `<p class="font-bold text-blue-900 text-sm">${cityName}</p>` : ``}
                      </div>
                      ${placeName ? `<p class="ml-3 text-blue-600 text-xs">${placeName}</p>` : ``}
                      ${atmosphere ? `<p class="ml-4 text-blue-500 text-[10px]">${atmosphere}</p>` : ``}
                    </div>
                  </div>
                </div>
              ` : ``}
            </div>

            <div class="relative bg-gray-50 aspect-square overflow-hidden">
              ${images.length > 0 ? `
                <div class="swiper feed-swiper w-full h-full" id="${swiperId}" data-post-id="${p.id}">
                  <div class="swiper-wrapper w-full h-full">
                    ${images.map(path => `
                      <div class="swiper-slide w-full h-full">
                        <img src="${escapeHtml(path)}" class="w-full h-full object-cover" alt="post image">
                      </div>
                    `).join("")}
                  </div>
                  ${images.length > 1 ? `<div class="swiper-pagination"></div>` : ``}
                </div>
              ` : `
                <div class="w-full h-full flex flex-col items-center justify-center text-gray-300">
                  <i data-lucide="image-off" class="w-16 h-16 mb-2"></i>
                  <p class="text-sm">이미지가 없습니다</p>
                </div>
              `}
            </div>

            <div class="border-t border-gray-300 p-3 pl-1 pr-1 space-y-3">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-1.5 transition-opacity">

                  <!-- ✅ 버튼/아이콘/카운트 모두 data-post-id를 가진다 -->
                  <button type="button" class="btn-like" data-post-id="${p.id}">
                    ${liked ? `
                      <i class="bi bi-heart-fill text-danger btn-like-icon unlike-btn" data-post-id="${p.id}"></i>
                    ` : `
                      <i class="bi bi-heart text-dark btn-like-icon icon-stroke-thick like-btn" data-post-id="${p.id}"></i>
                    `}
                    <span class="count-text like-count" data-post-id="${p.id}">${likeCount}</span>
                  </button>

                  <button type="button" class="open-post-detail ml-2"
                          data-post-id="${p.id}"
                          data-nickname="${nick}"
                          data-location="${countryName} - ${cityName}"
                          data-content="${contents}">
                    <i class="bi bi-chat text-dark btn-like-icon icon-stroke-thick"></i>
                    <span class="count-text">${commentCount}</span>
                  </button>

                  <button type="button" class="ml-3">
                    <i class="bi bi-share text-dark btn-like-icon icon-stroke-thick"></i>
                  </button>
                  <button type="button" class="ml-3">
                    <i class="bi bi-send text-dark btn-like-icon icon-stroke-thick"></i>
                  </button>
                </div>

                <button type="button">
                  <i class="bi bi-bookmark text-dark btn-like-icon icon-stroke-thick"></i>
                </button>
              </div>

              <div class="flex gap-2 text-m mt-3">
                <span class="font-bold">${nick}</span>
                <span>${contents}</span>
              </div>

              ${p.musicUrl ? `
                <div class="flex items-center gap-2 text-xs text-blue-600 bg-blue-50 px-3 py-2 rounded-lg">
                  <i data-lucide="music" class="w-4 h-4"></i>
                  <span class="truncate">${escapeHtml(p.musicUrl)}</span>
                </div>
              ` : ``}
            </div>

          </div>
        `;
            }

            function renderUsers(users) {
                if (!users || users.length === 0) {
                    $("#userSection").addClass("hidden");
                    $("#userList").empty();
                    return 0;
                }

                $("#userSection").removeClass("hidden");

                const html = users.map(u => {
                    const nick = escapeHtml(u.nickName || u.username || "User");
                    const bio = escapeHtml(u.profileWord || u.bio || "");
                    const img = safeProfile(u.profileImg);

                    return `
            <div class="flex items-center gap-4 p-4 bg-white rounded-2xl border border-gray-100 hover:shadow-lg transition-all cursor-pointer group user-row"
                 data-user-id="${u.id || u.userId || ""}">
              <img class="w-12 h-12 rounded-full object-cover border border-gray-100"
                   src="${img}" alt="profile">
              <div class="flex-1">
                <p class="font-bold text-gray-900">${nick}</p>
                <p class="text-xs text-gray-500 mt-0.5">${bio}</p>
              </div>
              <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i>
            </div>
          `;
                }).join("");

                $("#userList").html(html);
                return users.length;
            }

            function renderCountries(countries) {
                // (너 페이지에는 countrySection/countryList가 없어서 countries는 postSection에 같이 묶어 쓰는 형태라면 이 함수는 안 써도 된다)
                return countries ? countries.length : 0;
            }

            function renderPosts(posts) {
                if (!posts || posts.length === 0) {
                    $("#postSection").addClass("hidden");
                    $("#postList").empty();
                    return 0;
                }

                $("#postSection").removeClass("hidden");

                const html = posts.map(p => renderPostCardLike(p)).join("");
                $("#postList").html(html);
                return posts.length;
            }

            function initSearchSwipers() {
                if (typeof Swiper === "undefined") return;

                document.querySelectorAll(".feed-swiper").forEach(el => {
                    if (el.swiper) return; // 중복 방지

                    new Swiper(el, {
                        loop: false,
                        pagination: {
                            el: el.querySelector(".swiper-pagination"),
                            clickable: true
                        }
                    });
                });
            }

            function renderAll(data) {
                const payload = data && data.data ? data.data : null;

                const users = payload && payload.users ? payload.users : [];
                const posts = payload && payload.posts ? payload.posts : [];
                const countries = payload && payload.countries ? payload.countries : [];

                if (!searchQuery) {
                    $("#emptyState").show();
                    $("#searchResults").addClass("hidden");
                    return;
                }

                $("#emptyState").hide();
                $("#searchResults").removeClass("hidden");

                let userCount = 0, postCount = 0, countryCount = 0;

                if (searchType === "all" || searchType === "users") {
                    userCount = renderUsers(users);
                } else {
                    $("#userSection").addClass("hidden");
                    $("#userList").empty();
                }

                if (searchType === "all" || searchType === "countries") {
                    countryCount = renderCountries(countries);
                    postCount = renderPosts(posts);
                } else {
                    $("#postSection").addClass("hidden");
                    $("#postList").empty();
                }

                if (userCount === 0 && countryCount === 0 && postCount === 0) {
                    $("#noResults").removeClass("hidden").find("p")
                        .text(`"${searchQuery}"에 대한 결과가 없습니다.`);
                } else {
                    $("#noResults").addClass("hidden");
                }

                if (window.lucide) lucide.createIcons();
                initSearchSwipers();
            }

            // -------------------------
            // search events
            // -------------------------
            function runSearch() {
                const q = searchQuery.trim();
                if (!q) {
                    $("#emptyState").show();
                    $("#searchResults").addClass("hidden");
                    return;
                }

                apiSearch(q, searchType)
                    .done(function (res) {
                        if (!res || res.result === "fail") {
                            $("#userSection").addClass("hidden");
                            $("#postSection").addClass("hidden");
                            $("#noResults").removeClass("hidden").find("p")
                                .text(`"${searchQuery}"에 대한 결과가 없습니다.`);
                            if (window.lucide) lucide.createIcons();
                            return;
                        }
                        renderAll(res);
                    })
                    .fail(function () {
                        $("#noResults").removeClass("hidden").find("p").text("검색 중 오류가 발생했다");
                    });
            }

            $("#searchInput").on("input", function () {
                searchQuery = $(this).val();
                clearTimeout(timer);
                timer = setTimeout(runSearch, 250);
            });

            $(".tab-btn").on("click", function () {
                searchType = $(this).data("tab");

                $(".tab-btn").removeClass("bg-white shadow-md text-blue-600")
                    .addClass("text-gray-500 hover:text-gray-700");
                $(".tab-btn i").removeClass("fill-blue-600/10");

                $(this).addClass("bg-white shadow-md text-blue-600")
                    .removeClass("text-gray-500 hover:text-gray-700");
                $(this).find("i").addClass("fill-blue-600/10");

                runSearch();
            });

            // -------------------------
            // ✅ LIKE FINAL: single handler + sync
            // -------------------------
            function syncCardLikeUI(postId, liked, likeCount) {
                const $icons = $(`.btn-like-icon[data-post-id='${postId}']`);
                $icons.each(function () {
                    const $icon = $(this);
                    if (liked) {
                        $icon.removeClass("bi-heart text-dark like-btn")
                            .addClass("bi-heart-fill text-danger unlike-btn");
                    } else {
                        $icon.removeClass("bi-heart-fill text-danger unlike-btn")
                            .addClass("bi-heart text-dark like-btn icon-stroke-thick");
                    }
                });

                if (likeCount != null) {
                    $(`.like-count[data-post-id='${postId}']`).text(String(likeCount));
                }
            }

            $(document).on("click", ".btn-like, .btn-like-icon", function (e) {
                e.preventDefault();
                e.stopPropagation();

                const $t = $(this);
                const postId = Number($t.data("post-id")) || Number($t.closest(".btn-like").data("post-id"));
                if (!postId) return;

                const $icon = $(`.btn-like-icon[data-post-id='${postId}']`).first();
                const isLiked = $icon.hasClass("bi-heart-fill") || $icon.hasClass("unlike-btn");

                const $count = $(`.like-count[data-post-id='${postId}']`).first();
                const now = parseInt($count.text() || "0", 10) || 0;

                // optimistic update
                const nextLiked = !isLiked;
                const nextCount = Math.max(0, now + (nextLiked ? 1 : -1));
                syncCardLikeUI(postId, nextLiked, nextCount);

                const req = nextLiked ? apiLike(postId) : apiUnlike(postId);
                req.done(function (res) {
                    if (!res || res.result === "fail") {
                        // rollback
                        syncCardLikeUI(postId, isLiked, now);
                        return;
                    }

                    // 서버가 likeCount 내려주면 최종 동기화
                    const serverCount =
                        (res.data && res.data.likeCount != null) ? res.data.likeCount :
                            (res.likeCount != null) ? res.likeCount :
                                null;

                    if (serverCount != null) {
                        syncCardLikeUI(postId, nextLiked, serverCount);
                    }
                }).fail(function () {
                    // rollback
                    syncCardLikeUI(postId, isLiked, now);
                });
            });


            $(document).on("click", ".open-post-detail", function () {
                const postId = $(this).data("post-id");
                if (typeof window.openPostDetailModal === "function") {
                    window.openPostDetailModal(postId);
                    return;
                }
                console.log("open detail for postId:", postId);
            });

            if (window.lucide) lucide.createIcons();
        });
    </script>
</th:block>

</html>
